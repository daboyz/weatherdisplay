#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include <GxEPD2_3C.h>
#include <Fonts/FreeMonoBold12pt7b.h>
#include <Fonts/FreeMonoBold24pt7b.h>
#include <Fonts/FreeMonoBold9pt7b.h>

// Note: Adafruit GFX fonts are available in specific sizes only
// Standard sizes: 9pt, 12pt, 18pt, 24pt
// We'll use a workaround to make text appear larger

// WiFi credentials
const char* ssid = "XXXXXXXXX";
const char* password = "XXXXXXXXX";

// OpenWeatherMap API
const char* apiKey = "XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX";
const char* city = "Lviv";
const char* countryCode = "UA";

// Display instance for Waveshare 2.13" 3-color (212x104 pixels)
GxEPD2_3C<GxEPD2_213_Z98c, GxEPD2_213_Z98c::HEIGHT> display(GxEPD2_213_Z98c(/*CS=*/ 15, /*DC=*/ 27, /*RST=*/ 26, /*BUSY=*/ 25));

// Deep sleep time (30 minutes = 1800 seconds)
#define SLEEP_DURATION 1800

// SPI pins
#define EPD_MOSI 14
#define EPD_CLK 13

// RTC memory to store previous weather state (survives deep sleep)
RTC_DATA_ATTR int prevTemp = -999;
RTC_DATA_ATTR int prevFeelsLike = -999;
RTC_DATA_ATTR int prevWeatherId = -999;
RTC_DATA_ATTR int prevPrecipProb = -999;
RTC_DATA_ATTR int prevWindSpeed = -999;
RTC_DATA_ATTR int prevHighTemp = -999;
RTC_DATA_ATTR int prevLowTemp = -999;
RTC_DATA_ATTR int dinoPosition = 0;

// Wind icon bitmap (32x32px) - simplified wind symbol
const unsigned char icon_wind[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xff, 0xff, 0xff, 0x81, 0xff, 
	0xff, 0xff, 0x18, 0xff, 0xff, 0xff, 0x3c, 0xff, 0xff, 0xff, 0x3c, 0xff, 0xff, 0xff, 0xf8, 0xff, 
	0xc2, 0x00, 0x01, 0xff, 0xc2, 0x00, 0x03, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x0f, 
	0xc0, 0x00, 0x00, 0x07, 0xff, 0xff, 0xff, 0xe3, 0xc2, 0x00, 0x1c, 0xf3, 0xc2, 0x00, 0x0c, 0xf3, 
	0xff, 0xff, 0xc4, 0x63, 0xff, 0xf9, 0xe6, 0x07, 0xff, 0xf9, 0xe7, 0x0f, 0xff, 0xf8, 0xc7, 0xff, 
	0xff, 0xfc, 0x0f, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// Dinosaur icon bitmap (48x32px)
const unsigned char icon_dino[] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xf0, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x7f, 
  0xff, 0xff, 0xff, 0xff, 0xc0, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x1f, 
  0xff, 0xff, 0xff, 0xff, 0xdf, 0x8f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe3, 
  0xff, 0xeb, 0xff, 0xff, 0xff, 0xe1, 0xff, 0xff, 0x1f, 0xff, 0xff, 0xe1, 
  0xff, 0xff, 0xf3, 0xff, 0xff, 0xe1, 0xff, 0xff, 0xfe, 0xff, 0xff, 0xc1, 
  0xff, 0xff, 0xff, 0x7f, 0xff, 0xc1, 0xff, 0xff, 0xff, 0xbf, 0xff, 0xc1, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0xff, 0xff, 0xff, 0xbf, 0xfe, 0x03, 
  0xff, 0xff, 0xff, 0xff, 0xfc, 0x03, 0xff, 0xff, 0xfc, 0xff, 0xf0, 0x03, 
  0xff, 0xff, 0xf1, 0xff, 0xe0, 0x03, 0xff, 0xfc, 0x1f, 0xff, 0xc0, 0x07, 
  0xff, 0xe3, 0xff, 0xff, 0x80, 0x07, 0xff, 0x9f, 0xff, 0xff, 0x00, 0x0f, 
  0xff, 0x7f, 0xff, 0xfc, 0x00, 0x0f, 0xff, 0x7f, 0xff, 0xf0, 0x00, 0x0f, 
  0xff, 0xbf, 0xff, 0xe0, 0x00, 0x0f, 0xff, 0x8f, 0xff, 0x00, 0x00, 0x0f, 
  0xff, 0xc3, 0xf0, 0x00, 0x00, 0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x1f, 
  0xff, 0xff, 0xf0, 0x03, 0x8c, 0x1f, 0xff, 0xff, 0xff, 0xff, 0x9c, 0x3f
};

// Weather icon bitmaps (48x48 pixels)
const unsigned char icon_clear[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xfd, 
	0xff, 0x3f, 0xef, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0x8f, 0xff, 
	0xff, 0xfe, 0x3e, 0x3f, 0x1f, 0xff, 0xff, 0xff, 0x78, 0x07, 0xbf, 0xff, 0xff, 0xff, 0xe0, 0x03, 
	0xff, 0xff, 0xff, 0xff, 0xc3, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xf8, 0xff, 0xff, 0xff, 0xff, 
	0x9f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0x9f, 0xfe, 0x7f, 0xff, 
	0xff, 0x83, 0x3f, 0xfe, 0x60, 0xff, 0xff, 0x83, 0x1f, 0xfe, 0x60, 0xff, 0xff, 0xff, 0x9f, 0xfe, 
	0x7f, 0xff, 0xff, 0xff, 0x9f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xf8, 0xff, 0xff, 0xff, 0xff, 
	0xc7, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xe1, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0x3c, 0x0f, 0x3f, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0x1f, 0xff, 0xff, 0xfc, 0x7f, 0xff, 
	0x8f, 0xff, 0xff, 0xf8, 0xff, 0x7f, 0xcf, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_partly_cloudy[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xcf, 
	0xff, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xf9, 0xff, 0xff, 0xfe, 0x3f, 0xff, 0xf1, 0xff, 0xff, 0xff, 
	0x1f, 0xff, 0xe3, 0xff, 0xff, 0xff, 0x9e, 0x01, 0xe7, 0xff, 0xff, 0xff, 0xf8, 0x00, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0xe3, 0xfe, 0x3f, 0xff, 0xff, 0xff, 0xe7, 0xff, 
	0x1f, 0xff, 0xff, 0xff, 0xc7, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xcf, 0xff, 0x9f, 0xff, 0xff, 0xff, 
	0xcf, 0xff, 0x9f, 0xff, 0xff, 0xc1, 0xcf, 0xff, 0x8c, 0x1f, 0xff, 0xc1, 0xcf, 0xff, 0x8c, 0x1f, 
	0xff, 0xff, 0xcf, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0x1f, 0xff, 0xff, 0xff, 0xc3, 0xff, 0x3f, 0xff, 0xff, 0xff, 0x00, 0xfc, 0x7f, 0xff, 0xff, 0xf2, 
	0x38, 0x70, 0xff, 0xff, 0xff, 0xc0, 0x7e, 0x71, 0xef, 0xff, 0xff, 0x80, 0xfe, 0x3f, 0xe7, 0xff, 
	0xff, 0x1f, 0xff, 0x3f, 0xe3, 0xff, 0xff, 0x1f, 0xff, 0x3f, 0xf1, 0xff, 0xfe, 0x3f, 0xff, 0x1f, 
	0xf9, 0xff, 0xfc, 0x3f, 0xff, 0x0f, 0xff, 0xff, 0xfc, 0xff, 0xff, 0x87, 0xff, 0xff, 0xf8, 0xff, 
	0xff, 0xe3, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xe3, 0xff, 0xff, 
	0xf8, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xfc, 0x7f, 0xff, 0xc7, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x0f, 
	0xff, 0xff, 0xff, 0x80, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_cloudy[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x7f, 0xff, 0xff, 0xff, 
	0xfc, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xf8, 0x7f, 0x0f, 0xff, 0xff, 0xff, 0xf1, 0xff, 0x8f, 0xff, 
	0xff, 0xfc, 0x03, 0xff, 0xc7, 0xff, 0xff, 0xf0, 0x07, 0xff, 0xe7, 0xff, 0xff, 0xf1, 0xf7, 0xff, 
	0xf3, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xcf, 
	0xff, 0xff, 0xf3, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xf3, 0xff, 0xff, 0x0f, 0xff, 0xff, 0xf1, 0xff, 
	0xfe, 0x0f, 0xff, 0xff, 0xf0, 0x7f, 0xfc, 0x7f, 0xff, 0xff, 0xf4, 0x1f, 0xfc, 0xff, 0xff, 0xff, 
	0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 
	0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 
	0xf8, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xfe, 0x3f, 0xff, 0xff, 
	0xff, 0x1f, 0xfe, 0x0f, 0xff, 0xff, 0xf8, 0x3f, 0xff, 0x80, 0x00, 0x00, 0x00, 0x7f, 0xff, 0xf0, 
	0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_rain[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xfc, 0x7e, 0x1f, 0xff, 
	0xff, 0xff, 0xf8, 0xff, 0x8f, 0xff, 0xff, 0xfc, 0x03, 0xff, 0xc7, 0xff, 0xff, 0xf0, 0x03, 0xff, 
	0xe7, 0xff, 0xff, 0xf1, 0xf7, 0xff, 0xf3, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xc7, 
	0xff, 0xff, 0xf3, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xf3, 0xff, 
	0xff, 0x8f, 0xff, 0xff, 0xf3, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xf0, 0x7f, 0xfe, 0x3f, 0xff, 0xff, 
	0xf0, 0x3f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xf9, 0xff, 
	0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 
	0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xfc, 0xff, 0xfb, 0x9d, 
	0xff, 0xcf, 0xfc, 0x7f, 0xf3, 0x99, 0xff, 0x9f, 0xfe, 0x3f, 0xf3, 0x19, 0xfe, 0x1f, 0xff, 0x00, 
	0x67, 0x31, 0x00, 0x3f, 0xff, 0xc0, 0x67, 0x33, 0x01, 0xff, 0xff, 0xff, 0xe6, 0x73, 0xff, 0xff, 
	0xff, 0xff, 0xce, 0x67, 0xff, 0xff, 0xff, 0xff, 0xcc, 0xe7, 0xff, 0xff, 0xff, 0xff, 0x9c, 0xcf, 
	0xff, 0xff, 0xff, 0xff, 0x98, 0xcf, 0xff, 0xff, 0xff, 0xff, 0x19, 0xcf, 0xff, 0xff, 0xff, 0xff, 
	0x39, 0x9f, 0xff, 0xff, 0xff, 0xff, 0x33, 0x9f, 0xff, 0xff, 0xff, 0xff, 0x73, 0xbf, 0xff, 0xff, 
	0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_snow[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 
	0xf9, 0x6f, 0xff, 0xff, 0xff, 0xfd, 0xdc, 0x0d, 0xdf, 0xff, 0xff, 0xfc, 0xce, 0x1d, 0x9f, 0xff, 
	0xff, 0xfe, 0x4f, 0x3c, 0x3f, 0xff, 0xff, 0xff, 0x0f, 0x7c, 0x7f, 0xff, 0xff, 0xfc, 0x0f, 0x7c, 
	0x1f, 0xff, 0xff, 0xfe, 0x0f, 0x78, 0x3f, 0xff, 0xff, 0xff, 0xe7, 0x73, 0xff, 0xff, 0xff, 0xfb, 
	0xf3, 0x67, 0xe7, 0xff, 0xff, 0xf9, 0xf8, 0x0f, 0xcf, 0xff, 0xff, 0xfc, 0xfc, 0x1f, 0x9f, 0xff, 
	0xff, 0xc0, 0x00, 0x00, 0x01, 0xff, 0xff, 0xe0, 0x00, 0x1f, 0x9f, 0xff, 0xff, 0xfc, 0xfc, 0x0f, 
	0xcf, 0xff, 0xff, 0xf9, 0xf9, 0x27, 0xe7, 0xff, 0xff, 0xff, 0xf3, 0x33, 0xff, 0xff, 0xff, 0xff, 
	0xe7, 0x39, 0xff, 0xff, 0xff, 0xfc, 0x0f, 0x3c, 0x1f, 0xff, 0xff, 0xfe, 0x0f, 0x3c, 0x7f, 0xff, 
	0xff, 0xff, 0x0f, 0x3c, 0x3f, 0xff, 0xff, 0xfe, 0x4e, 0x3d, 0x9f, 0xff, 0xff, 0xfc, 0xcc, 0x1d, 
	0xdf, 0xff, 0xff, 0xff, 0xf9, 0x0f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_thunderstorm[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0x81, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x7f, 0xff, 0xff, 0xff, 0xfc, 0x3e, 0x1f, 0xff, 
	0xff, 0xff, 0xf8, 0xff, 0x8f, 0xff, 0xff, 0xfc, 0x01, 0xff, 0xc7, 0xff, 0xff, 0xf8, 0x03, 0xff, 
	0xe7, 0xff, 0xff, 0xf1, 0xe7, 0xff, 0xf3, 0xff, 0xff, 0xe3, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xe7, 
	0xff, 0xff, 0xf3, 0xff, 0xff, 0xc7, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xcf, 0xff, 0xff, 0xf3, 0xff, 
	0xff, 0x8f, 0xff, 0xff, 0xf3, 0xff, 0xfe, 0x0f, 0xff, 0xff, 0xf0, 0x7f, 0xfe, 0x3f, 0xff, 0xff, 
	0xf0, 0x3f, 0xfc, 0x7f, 0xff, 0xff, 0xff, 0x1f, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xf9, 0xff, 
	0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0xcf, 0xff, 0xcf, 
	0xf9, 0xff, 0xff, 0xcf, 0xff, 0xcf, 0xf9, 0xff, 0xff, 0x9f, 0xff, 0xcf, 0xfc, 0xff, 0xff, 0x1f, 
	0xff, 0x8f, 0xfc, 0x7f, 0xff, 0x3f, 0xff, 0x9f, 0xfe, 0x3f, 0xfe, 0x7f, 0xfe, 0x3f, 0xff, 0x00, 
	0x7c, 0x7f, 0x00, 0x7f, 0xff, 0xc0, 0x7c, 0xff, 0x01, 0xff, 0xff, 0xff, 0xf8, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xf0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8f, 0xff, 0xff, 0xff, 0xe7, 0x3f, 0x9e, 
	0x73, 0xff, 0xff, 0xc6, 0x3f, 0x9e, 0x73, 0xff, 0xff, 0xce, 0x7f, 0x3c, 0xe7, 0xff, 0xff, 0x8c, 
	0x7e, 0x3c, 0xe7, 0xff, 0xff, 0x9c, 0xfe, 0x79, 0xcf, 0xff, 0xff, 0xbd, 0xfc, 0xfd, 0xef, 0xff, 
	0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xf3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

const unsigned char icon_fog[] PROGMEM = {
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xf0, 0xff, 
	0xff, 0xff, 0xff, 0x9f, 0xfc, 0x7f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x1f, 0xf0, 0xff, 0xff, 0xff, 
	0xff, 0x80, 0x03, 0xff, 0xff, 0xfe, 0x1f, 0xf0, 0x0f, 0xff, 0xff, 0xf0, 0x03, 0xff, 0xff, 0xff, 
	0xff, 0xc7, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xfe, 0x3f, 0xfc, 0xff, 0xff, 0xff, 0xff, 0x1f, 
	0xe0, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x03, 0xff, 0xff, 0xfe, 0x1f, 0xf8, 0x1f, 0xff, 0xff, 0xf0, 
	0x03, 0xff, 0xff, 0xff, 0xff, 0xc7, 0xf8, 0xff, 0xff, 0xff, 0xff, 0x9f, 0xfe, 0x3f, 0xfc, 0xff, 
	0xff, 0xff, 0xff, 0x0f, 0xe1, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x07, 0xff, 0xff, 0xff, 0xff, 0xf8, 
	0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

// Weather data structure
struct WeatherData {
  float temp;
  float feels_like;
  String description;
  String main;
  int weatherId;
  float wind_speed;
  int precipProb;
  float highTemp;
  float lowTemp;
} weather;

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("Weather Display Starting...");
  
  btStop();
  Serial.println("Bluetooth disabled");
  
  SPI.begin(EPD_CLK, -1, EPD_MOSI, 15);
  
  Serial.println("Initializing display...");
  display.init(115200, true, 2, false);
  display.setRotation(1);
  display.setTextColor(GxEPD_BLACK);
  
  connectWiFi();
  
  if (getWeatherData()) {
    int currentTemp = (int)round(weather.temp);
    int currentFeelsLike = (int)round(weather.feels_like);
    int currentWindSpeed = (int)round(weather.wind_speed * 3.6);
    
    bool weatherChanged = (currentTemp != prevTemp) || 
                         (currentFeelsLike != prevFeelsLike) ||
                         (weather.weatherId != prevWeatherId) ||
                         (weather.precipProb != prevPrecipProb) ||
                         ((currentWindSpeed >= 20) != (prevWindSpeed >= 20)) ||
                         ((int)weather.highTemp != prevHighTemp) ||
                         ((int)weather.lowTemp != prevLowTemp);
    
    if (weatherChanged) {
      Serial.println("Weather changed - updating display");
      displayWeather();
      
      prevTemp = currentTemp;
      prevFeelsLike = currentFeelsLike;
      prevWeatherId = weather.weatherId;
      prevPrecipProb = weather.precipProb;
      prevWindSpeed = currentWindSpeed;
      prevHighTemp = (int)weather.highTemp;
      prevLowTemp = (int)weather.lowTemp;
      
      dinoPosition = (dinoPosition + 1) % 3;
    } else {
      Serial.println("Weather unchanged - skipping display update");
    }
  } else {
    displayError();
  }
  
  WiFi.disconnect(true);
  WiFi.mode(WIFI_OFF);
  
  Serial.println("Going to sleep for 30 minutes...");
  esp_sleep_enable_timer_wakeup(SLEEP_DURATION * 1000000ULL);
  esp_deep_sleep_start();
}

void loop() {
}

void connectWiFi() {
  Serial.print("Connecting to WiFi");
  WiFi.setSleep(true);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 10) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nConnected!");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("\nFailed to connect!");
  }
}

bool getWeatherData() {
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("WiFi not connected");
    return false;
  }
  
  HTTPClient http;
  
  String url = "http://api.openweathermap.org/data/2.5/weather?q=" + 
               String(city) + "," + String(countryCode) + 
               "&appid=" + String(apiKey) + "&units=metric";
  
  Serial.println("Fetching current weather...");
  http.begin(url);
  int httpCode = http.GET();
  
  if (httpCode != 200) {
    Serial.print("HTTP Error: ");
    Serial.println(httpCode);
    http.end();
    return false;
  }
  
  String payload = http.getString();
  DynamicJsonDocument doc(2048);
  DeserializationError error = deserializeJson(doc, payload);
  
  if (error) {
    Serial.print("JSON parsing failed: ");
    Serial.println(error.c_str());
    http.end();
    return false;
  }
  
  weather.temp = doc["main"]["temp"];
  weather.feels_like = doc["main"]["feels_like"];
  weather.description = doc["weather"][0]["description"].as<String>();
  weather.main = doc["weather"][0]["main"].as<String>();
  weather.weatherId = doc["weather"][0]["id"];
  weather.wind_speed = doc["wind"]["speed"];
  
  Serial.println("Temp: " + String(weather.temp) + "°C");
  Serial.println("Feels: " + String(weather.feels_like) + "°C");
  Serial.println("Wind: " + String(weather.wind_speed) + " m/s");
  
  http.end();
  
  String forecastUrl = "http://api.openweathermap.org/data/2.5/forecast?q=" + 
                       String(city) + "," + String(countryCode) + 
                       "&appid=" + String(apiKey) + "&units=metric";
  
  Serial.println("Fetching forecast...");
  http.begin(forecastUrl);
  httpCode = http.GET();
  
  if (httpCode != 200) {
    Serial.print("Forecast Error: ");
    Serial.println(httpCode);
    http.end();
    return false;
  }
  
  payload = http.getString();
  DynamicJsonDocument forecastDoc(16384);
  error = deserializeJson(forecastDoc, payload);
  
  if (error) {
    Serial.print("Forecast JSON failed: ");
    Serial.println(error.c_str());
    http.end();
    return false;
  }
  
  weather.precipProb = (int)(forecastDoc["list"][0]["pop"].as<float>() * 100);
  Serial.println("Precip: " + String(weather.precipProb) + "%");
  
  weather.highTemp = weather.temp;
  weather.lowTemp = weather.temp;
  
  Serial.println("Calculating high/low from forecast...");
  Serial.println("Starting with current: " + String(weather.temp) + "°C");
  
  JsonArray forecastList = forecastDoc["list"].as<JsonArray>();
  int count = 0;
  
  for (JsonVariant value : forecastList) {
    if (count >= 8) break;
    
    JsonObject entry = value.as<JsonObject>();
    
    if (entry.containsKey("main")) {
      JsonObject main = entry["main"];
      if (main.containsKey("temp")) {
        float forecastTemp = main["temp"].as<float>();
        
        Serial.println("  Forecast " + String(count) + ": " + String(forecastTemp) + "°C");
        
        if (forecastTemp > weather.highTemp) {
          weather.highTemp = forecastTemp;
        }
        if (forecastTemp < weather.lowTemp) {
          weather.lowTemp = forecastTemp;
        }
        
        count++;
      }
    }
  }
  
  Serial.println("Final High: " + String(weather.highTemp) + "°C (from " + String(count) + " entries)");
  Serial.println("Final Low: " + String(weather.lowTemp) + "°C");
  
  http.end();
  return true;
}

void displayWeather() {
  Serial.println("Updating display...");
  
  display.setRotation(1);
  display.setFullWindow();
  display.firstPage();
  
  do {
    display.fillScreen(GxEPD_WHITE);
    
    // === LEFT SIDE: Temperature & Feels Like ===
    int leftHalfWidth = 106;
    
    int tempValue = (int)round(weather.temp);
    if (tempValue > 0) {
      display.setTextColor(GxEPD_RED);
    } else {
      display.setTextColor(GxEPD_BLACK);
    }
    
    display.setFont(&FreeMonoBold24pt7b);
    String tempStr = String(tempValue) + "°";
    
    int16_t x1, y1;
    uint16_t w, h;
    display.getTextBounds(tempStr, 0, 0, &x1, &y1, &w, &h);
    int tempX = (leftHalfWidth - w) / 2 - x1;
    display.setCursor(tempX, 38);
    display.print(tempStr);
    
    display.setTextColor(GxEPD_BLACK);
    display.setFont(&FreeMonoBold9pt7b);
    int feelsValue = (int)round(weather.feels_like);
    String feelsStr = String(feelsValue) + "°";
    
    display.getTextBounds(feelsStr, 0, 0, &x1, &y1, &w, &h);
    int feelsX = (leftHalfWidth - w) / 2 - x1;
    display.setCursor(feelsX, 58);
    display.print(feelsStr);
    
    // === RIGHT SIDE: Weather Icon ===
    int rightHalfStart = 106;
    
    int iconX = rightHalfStart + (leftHalfWidth - 48) / 2;
    drawWeatherIcon(weather.weatherId, iconX, 8);
    
    // === BOTTOM INFO BAR: Wind, Precipitation, High/Low ===
    display.setFont(&FreeMonoBold9pt7b);
    int infoY = 76;
    int windSpeed = (int)round(weather.wind_speed * 3.6);
    
    String precipStr = String(weather.precipProb) + "%";
    String highStr = String((int)weather.highTemp);
    String lowStr = String((int)weather.lowTemp);
    String highLowStr = "H" + highStr + "  L" + lowStr;
    
    if (windSpeed >= 20) {
      String windStr = String(windSpeed);
      
      display.getTextBounds(windStr, 0, 0, &x1, &y1, &w, &h);
      int windTextW = w;
      display.getTextBounds(precipStr, 0, 0, &x1, &y1, &w, &h);
      int precipW = w;
      display.getTextBounds(highLowStr, 0, 0, &x1, &y1, &w, &h);
      int highLowW = w;
      
      int totalWidth = 32 + 5 + windTextW + 15 + precipW + 15 + highLowW;
      int startX = (212 - totalWidth) / 2 + 46;
      
      display.drawBitmap(startX, 50, icon_wind, 32, 32, GxEPD_WHITE, GxEPD_BLACK);
      
      display.setCursor(startX + 32 + 5, infoY);
      display.print(windStr);
      
      int precipX = startX + 32 + 5 + windTextW + 15;
      display.setCursor(precipX, infoY);
      display.print(precipStr);
      
      int highLowX = precipX + precipW + 15;
      display.setCursor(highLowX, infoY);
      display.print(highLowStr);
      
    } else {
      display.getTextBounds(precipStr, 0, 0, &x1, &y1, &w, &h);
      int precipW = w;
      display.getTextBounds(highLowStr, 0, 0, &x1, &y1, &w, &h);
      int highLowW = w;
      
      int totalWidth = precipW + 15 + highLowW;
      int startX = (212 - totalWidth) / 2 + 46;
      
      display.setCursor(startX, infoY);
      display.print(precipStr);
      
      display.setCursor(startX + precipW + 15, infoY);
      display.print(highLowStr);
    }
    
    // === BOTTOM: Dinosaur ===
    int dinoY = 88;
    int dinoX;
    
    switch(dinoPosition) {
      case 0: dinoX = 8; break;
      case 1: dinoX = 82; break;
      case 2: dinoX = 156; break;
      default: dinoX = 82;
    }
    
    display.drawBitmap(dinoX, dinoY, icon_dino, 48, 32, GxEPD_WHITE, GxEPD_BLACK);
    
  } while (display.nextPage());
  
  Serial.println("Display complete");
  display.hibernate();
}

void drawWeatherIcon(int weatherId, int x, int y) {
  const unsigned char* iconBitmap = nullptr;
  
  if (weatherId >= 200 && weatherId < 300) {
    iconBitmap = icon_thunderstorm;
  } else if (weatherId >= 300 && weatherId < 600) {
    iconBitmap = icon_rain;
  } else if (weatherId >= 600 && weatherId < 700) {
    iconBitmap = icon_snow;
  } else if (weatherId >= 700 && weatherId < 800) {
    iconBitmap = icon_fog;
  } else if (weatherId == 800) {
    iconBitmap = icon_clear;
  } else if (weatherId == 801) {
    iconBitmap = icon_partly_cloudy;
  } else if (weatherId >= 802) {
    iconBitmap = icon_cloudy;
  }
  
  if (iconBitmap != nullptr) {
    display.drawBitmap(x, y, iconBitmap, 48, 48, GxEPD_WHITE, GxEPD_BLACK);
  }
}

void displayError() {
  Serial.println("Displaying error...");
  
  display.setFullWindow();
  display.firstPage();
  
  do {
    display.fillScreen(GxEPD_WHITE);
    display.setTextColor(GxEPD_RED);
    display.setFont(&FreeMonoBold12pt7b);
    display.setCursor(10, 40);
    display.println("Error!");
    display.setFont(&FreeMonoBold9pt7b);
    display.setCursor(10, 70);
    display.println("Check WiFi");
  } while (display.nextPage());
  
  display.hibernate();
}